<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç”»åƒ â†’ PNG å¤‰æ›</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

<style>
:root {
  --bg:#111; --text:#fff; --accent:#e53935; --border:#777;
}
body.light {
  --bg:#fff; --text:#000; --accent:#4fc3f7; --border:#999;
}
body {
  background:var(--bg); color:var(--text);
  font-family:sans-serif; padding:20px;
}
#drop {
  border:2px dashed var(--border);
  padding:30px; text-align:center; cursor:pointer;
  border-radius: 12px;
}
#drop.hover { 
  border-color: var(--accent);
  background: rgba(255,255,255,0.03);
}
button {
  background:var(--accent); color:#fff;
  border:none; padding:6px 10px; cursor:pointer;
  border-radius: 8px;
}
input { margin:4px; }
#status { margin-top:10px; }
</style>
</head>

<body>

<h2>ç”»åƒ â†’ PNG å¤‰æ›</h2>
<button id="theme">ğŸŒ™ / â˜€</button>

<div id="drop">ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ— or ã‚¯ãƒªãƒƒã‚¯</div>
<input type="file" id="file" multiple accept="image/*" hidden>

<h3>ã‚µã‚¤ã‚º</h3>
å¹… <input type="number" id="w">
é«˜ã• <input type="number" id="h">
<button id="reset">å…ƒã‚µã‚¤ã‚º</button><br>

<label><input type="checkbox" id="lock"> ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å›ºå®š</label><br>
<label><input type="checkbox" id="transparent"> èƒŒæ™¯é€æ˜</label>

<div id="status"></div>

<script>
let defaultW, defaultH, ratio;

const $ = id => document.getElementById(id);
const drop = $("drop"), fileInput = $("file");
const wInput = $("w"), hInput = $("h");
const status = $("status");

// ===== è¨­å®šä¿å­˜ =====
function save() {
  localStorage.setItem("imgtool", JSON.stringify({
    theme: document.body.classList.contains("light"),
    w: wInput.value, h: hInput.value,
    lock: $("lock").checked,
    transparent: $("transparent").checked
  }));
}
function load() {
  const d = JSON.parse(localStorage.getItem("imgtool") || "{}");
  if (d.theme) document.body.classList.add("light");
  if (d.w) wInput.value = d.w;
  if (d.h) hInput.value = d.h;
  $("lock").checked = d.lock ?? false;
  $("transparent").checked = d.transparent ?? true;
}
load();

// ===== UIæ“ä½œ =====
$("theme").onclick = () => {
  document.body.classList.toggle("light"); save();
};

$("reset").onclick = () => {
  if (defaultW) {
    wInput.value = defaultW;
    hInput.value = defaultH;
    save();
  }
};

wInput.oninput = () => {
  if ($("lock").checked && ratio) {
    hInput.value = Math.round(wInput.value / ratio);
  }
  save();
};
hInput.oninput = () => {
  if ($("lock").checked && ratio) {
    wInput.value = Math.round(hInput.value * ratio);
  }
  save();
};

drop.onclick = () => fileInput.click();
drop.ondragover = e => { e.preventDefault(); drop.classList.add("hover"); };
drop.ondragleave = () => drop.classList.remove("hover");
drop.ondrop = e => {
  e.preventDefault(); drop.classList.remove("hover");
  handleFiles(e.dataTransfer.files);
};
fileInput.onchange = () => handleFiles(fileInput.files);

// ===== ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ =====
document.addEventListener("keydown", e => {
  if (document.activeElement.tagName === "INPUT") return;
  if (e.key === "d") $("theme").click();
  if (e.key === "r") $("reset").click();
  if (e.key === "a") $("lock").checked ^= 1, save();
});

// ===== å¤‰æ›å‡¦ç† =====
async function handleFiles(files) {
  let i = 0;
  for (const file of files) {
    i++;
    status.textContent = `å¤‰æ›ä¸­ ${i} / ${files.length}`;

    const img = await loadImage(file);

    if (!defaultW) {
      defaultW = img.width;
      defaultH = img.height;
      ratio = img.width / img.height;
      wInput.value = defaultW;
      hInput.value = defaultH;
    }

    const w = +wInput.value || img.width;
    const h = +hInput.value || img.height;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = w; canvas.height = h;

    if (!$("transparent").checked) {
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,w,h);
    }

    ctx.drawImage(img,0,0,w,h);

    const blob = await new Promise(r=>canvas.toBlob(r,"image/png"));
    const name = file.name.replace(/\.\w+$/, "") + `_${w}x${h}.png`;
    download(blob,name);
  }
  status.textContent = "å®Œäº†ï¼";
}

// ===== EXIFå¯¾å¿œãƒ­ãƒ¼ãƒ‰ =====
function loadImage(file) {
  return new Promise(r => {
    const img = new Image();
    EXIF.getData(file, function() {
      const o = EXIF.getTag(this, "Orientation") || 1;
      img.onload = () => r(img);
      img.src = URL.createObjectURL(file);
    });
  });
}

function download(blob,name) {
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}
</script>

</body>
</html>
